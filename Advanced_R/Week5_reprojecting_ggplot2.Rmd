---
title: "Week5 - Spatial Points"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Reprojecting Raster data and plotting it with ggplot2

### Quick tutorial - ggplot2 themes
Ever notice the gray background on ggplot2? Well that's referred to as the default theme. There are other themes that can be called every time you createa a ggplot. Let's take a look:

The black & white theme
```{r}
library(ggplot2)

acadia = read.csv("/Users/james/Documents/Github/geog473-673/datasets/acadia.csv")

ggplot(acadia, aes(x=year, y=visitors)) +
    geom_line(col="yellow", size=5) + 
    geom_point(col="steelblue", size=3) + 
    geom_smooth(method="lm", col="firebrick") +
    labs(title="Acadia National Park Attendance", subtitle="Total Visitors per year", y="Visitors", x="Year", caption="National Park Database") +
    theme_bw()
  
```

The dark theme

```{r}
library(ggplot2)

acadia = read.csv("/Users/james/Documents/Github/geog473-673/datasets/acadia.csv")

ggplot(acadia, aes(x=year, y=visitors)) +
    geom_line(col="yellow", size=5) + 
    geom_point(col="steelblue", size=3) + 
    geom_smooth(method="lm", col="firebrick") +
    labs(title="Acadia National Park Attendance", subtitle="Total Visitors per year", y="Visitors", x="Year", caption="National Park Database") +
    theme_dark()
  
```

The light theme

```{r}
library(ggplot2)

acadia = read.csv("/Users/james/Documents/Github/geog473-673/datasets/acadia.csv")

ggplot(acadia, aes(x=year, y=visitors)) +
    geom_line(col="yellow", size=5) + 
    geom_point(col="steelblue", size=3) + 
    geom_smooth(method="lm", col="firebrick") +
    labs(title="Acadia National Park Attendance", subtitle="Total Visitors per year", y="Visitors", x="Year", caption="National Park Database") +
    theme_light()
  
```

The classic theme

```{r}
library(ggplot2)

acadia = read.csv("/Users/james/Documents/Github/geog473-673/datasets/acadia.csv")

ggplot(acadia, aes(x=year, y=visitors)) +
    geom_line(col="yellow", size=5) + 
    geom_point(col="steelblue", size=3) + 
    geom_smooth(method="lm", col="firebrick") +
    labs(title="Acadia National Park Attendance", subtitle="Total Visitors per year", y="Visitors",x="Year", caption="National Park Database") +
    theme_classic()
  
```


# Advanced Plotting - Synthesizing Shapefiles 

Often times, the spatial data that we want aren't in a nice, gridded lat/lon. The oblate spheroid that we call home presents some challenges when it comes to displaying spatial datasets. Often times, datasets like these are stored as separate entities - shapefiles & data tables. Fortunately, we have multiple avenues for working with this data. Let's check out a coastal flooding product that projects potential water levels above normal for each day. [coast-flood.udel.edu]

```{r}
#Load packages
library(RColorBrewer)
library(rgdal)
library(sp)
library(ggplot2)
library(ggmap)
library(scales)
library(viridis)

# Use the readOGR function to open a shapefile & constituents
coast.shp <- readOGR("/Users/james/Documents/Github/geog473-673/datasets/cfms_shapefiles/cfms_watersheds.shp")
class(coast.shp)
coast.shp@proj4string
```
This projection is **unique**. It's a transverse mercator with some specific lat_0 and lon_0 starting points. Notice the class of the shapefile - the underlying package controlling it's translation to R is the `sp` package -  A package providing classes and methods for spatial data: points, lines, polygons and grids. 

NOTE: Everytime you read in a shapefile like `cfms_watersheds.shp`, you MUST have the `.shx`, `.prj`, `.dbf`, etc. all within the SAME folder. Even though we are only keying an "opening" of the `.shp` file, `readOGR` is opening them all. 

ANOTHER NOTE: Notice the *@* symbol in `coast.shp@proj4string`. This is you query metadata associated with shapefiles. 

Back to plotting...
```{r}
plot(coast.shp)
# Open the dataset that corresponds to the water levels within the shapefile boxes 
coast.data <- read.csv("/Users/james/Documents/Github/geog473-673/datasets/cfms_shapefiles/water_levels.csv")
head(coast.data)
# now let's find the matching key - in this case, the matching key is the "station".
coast.shp$station
coast.data$station

# notice the difference above - the station order is not matching and we need to vectorize the coast.shp$station
coast.shp  = coast.shp[order(as.vector(coast.shp$station)),]
coast.data  = coast.data[order(as.vector(coast.data$station)),]

# merge on common variable, here called 'station' - we MUST use the duplicateGeoms argument because there are multiple values for the same station name
merged.coast = sp::merge(coast.shp,coast.data,by='station', duplicateGeoms = TRUE)

# Now let's use brewer.pal from RColorBrewer to create a blues color pallette
mycolours <- brewer.pal(8, "Blues")
mybreaks <- seq(0,6,0.5) 
# the data we're concerned with here is shortnamed maxpred - maximum predicted water level for the next 24 hours
cut(merged.coast$maxpred, mybreaks)
mycolourscheme <- mycolours[findInterval(merged.coast$maxpred, vec = mybreaks)]

```

The data is prepared, now we just need to plug in everything to plotting functions. First up is `spplot` from the `sp` package:

```{r}
spplot(merged.coast, "maxpred", par.settings = list(axis.line = list(col ="transparent")), main = "Projected Water Levels (Feet)", cuts = 5, col ="transparent", col.regions = mycolours)

```

Now we use the `tmap` function - very similar to `ggplot2`. `tmap` == Thematic Map Visualization. Thematic maps are geographical maps in which spatial data distributions are visualized. This package offers a flexible, layer-based, and easy to use approach to create thematic maps, such as choropleths and bubble maps. It is based on the grammar of graphics, and resembles the syntax of ggplot2.
```{r}
library(tmap)
tm_shape(merged.coast) + 
  tm_polygons(col='maxpred', title = "Projected Water Levels", palette = "Spectral") + tm_style("classic") + tm_scale_bar(position = c("left", "bottom")) 
```

Ok, so those are cool, but what about using `ggplot2`? It can be done, but we not out of the box...

```{r}
library(ggplot2)
library(scales)
library(ggmap)
library(viridis)
m@data$id <- rownames(m@data)
newUS <- fortify(m, region = "id")
newdf <- merge(newUS, m@data, by = "id")
Myplot <- ggplot() +
  geom_polygon(data = newdf, aes(fill = maxpred, 
                                 x = long, 
                                 y = lat.x, 
                                 group = group)) + ggtitle("Vote Percentage for Bush, 2004") + theme(plot.title = element_text(hjust =0.5))


```












load(url("https://github.com/valentinitnelav/RandomScripts/blob/master/NaturalEarth.RData?raw=true"))



ggplot() +
    # add Natural Earth countries projected to Robinson, give black border and fill with gray
    geom_polygon(data=NE_countries_rob, aes(long,lat, group=group), colour="black", fill="gray80", size = 0.25)

ggplot() + geom_polygon(data=NE_box_rob, aes(x=long, y=lat), colour="black", fill="transparent", size = 0.25)

ggplot() + geom_path(data=NE_graticules_rob, aes(long, lat, group=group), linetype="dotted", color="grey50", size = 0.25)

ggplot() + geom_text(data = lbl.Y.prj, aes(x = X.prj, y = Y.prj, label = lbl), color="grey50", size=2)

ggplot() + geom_text(data = lbl.X.prj, aes(x = X.prj, y = Y.prj, label = lbl), color="grey50", size=2)

df = as.data.frame(projTemClim, xy=TRUE)
ggplot() + geom_raster(data=df, aes(x=x, y=y, fill = CRU_Global_1961.1990_Mean_Monthly_Surface_Temperature_Climatology))

ggplot() +    geom_raster(data=df, aes(x=x, y=y, fill = CRU_Global_1961.1990_Mean_Monthly_Surface_Temperature_Climatology)) +
    # add Natural Earth countries projected to Robinson, give black border and fill with gray
    geom_polygon(data=NE_countries_rob, aes(long,lat, group=group), colour="black", fill="transparent", size = 0.25) +
    # Note: "Regions defined for each Polygons" warning has to do with fortify transformation. Might get deprecated in future!
    # alternatively, use use map_data(NE_countries) to transform to data frame and then use project() to change to desired projection.
    # add Natural Earth box projected to Robinson
    geom_polygon(data=NE_box_rob, aes(x=long, y=lat), colour="black", fill="transparent", size = 0.25) +
    # add graticules projected to Robinson
    geom_path(data=NE_graticules_rob, aes(long, lat, group=group), linetype="dotted", color="grey50", size = 0.25) +
    # add graticule labels - latitude and longitude
    geom_text(data = lbl.Y.prj, aes(x = X.prj, y = Y.prj, label = lbl), color="grey50", size=2) +
    geom_text(data = lbl.X.prj, aes(x = X.prj, y = Y.prj, label = lbl), color="grey50", size=2) +
    # the default, ratio = 1 in coord_fixed ensures that one unit on the x-axis is the same length as one unit on the y-axis
    coord_quickmap(xlim=range(df$x), ylim=range(df$y)) +
    my_theme + my_fill +
    # remove the background and default gridlines
    

my_theme <- theme_void() + theme(panel.ontop=TRUE, panel.background=element_blank())
my_cols <- scale_color_distiller(palette='Spectral')
my_fill <- scale_fill_distiller(palette='Spectral')
ggplot(df, aes(y=y, x=x, fill=CRU_Global_1961.1990_Mean_Monthly_Surface_Temperature_Climatology)) +
    borders('world', xlim=range(df$x), ylim=range(df$y), colour='black') + my_theme + my_fill +
    coord_quickmap(xlim=range(df$x), ylim=range(df$y))
    
ggplot(df, aes(y=y, x=x, fill=CRU_Global_1961.1990_Mean_Monthly_Surface_Temperature_Climatology)) + geom_polygon() +
    borders('world', xlim=range(df$x), ylim=range(df$y), colour='black') + my_theme + my_fill +
    coord_map('lambert', lat0=30, lat1=65, xlim=c(-20, 39), ylim=c(19, 75))
    
    
library(rasterVis)
r=projTemClim
ggplot(r) + geom_tile(aes(fill = value)) + 
  scale_fill_distiller(palette="Spectral", na.value = "transparent") +
  my_theme  

library(mapview)
mapview(r, legend = TRUE)  


nam = brick("Downloads/NAM_CONUS_80km_20200107_0000.grib1")

# Band 34 is temperature at 450hpa
